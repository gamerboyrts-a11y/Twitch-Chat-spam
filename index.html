<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Spam Tracker (7TV Support)</title>
    <style>
        body { background: linear-gradient(to bottom, #9146ff, #331a3d); color: white; font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        input, button { padding: 10px; font-size: 18px; margin: 10px; }
        #status { font-size: 20px; margin: 20px; }
        .top { font-size: 48px; margin: 30px; padding: 20px; border: 3px solid #9146ff; border-radius: 20px; background: rgba(0,0,0,0.5); min-height: 100px; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        img { width: 80px; height: 80px; margin-right: 20px; border-radius: 10px; }
        #top1 { border-color: gold; }
        #top2 { border-color: silver; }
        #top3 { border-color: #cd7f32; }
        #loading { color: #9146ff; }
    </style>
</head>
<body onload="load7TVEmotes()">
    <h1>Twitch Chat Spam Tracker (Top 3 + 7TV Emotes)</h1>
    <input id="channel" placeholder="Enter channel name (lowercase)" />
    <button onclick="connect()">Connect</button>
    <div id="status">Disconnected - Loading 7TV emotes...</div>
    <div id="top1" class="top">Top 1: -</div>
    <div id="top2" class="top">Top 2: -</div>
    <div id="top3" class="top">Top 3: -</div>

    <script>
        let ws = null;
        let spams = new Map(); // key -> {timestamps: []}
        const TAU = 300000; // 5 min decay
        const MAX_TIMESTAMPS = 100;
        const OLD_THRESHOLD = 3600000; // 1 hr
        let emoteMap = new Map(); // emote_name -> img_url

        async function load7TVEmotes() {
            try {
                document.getElementById('status').innerHTML += ' <span id="loading">7TV...</span>';
                const res = await fetch('https://7tv.io/v3/emotes/global');
                const data = await res.json();
                data.forEach(e => {
                    const name = e.name.toLowerCase();
                    const url = `https://cdn.7tv.app/emote/${e.id}/2x.webp`;
                    emoteMap.set(name, url);
                });
                document.getElementById('loading').remove();
                document.getElementById('status').textContent = 'Ready (7TV loaded)';
                console.log(`Loaded ${emoteMap.size} 7TV global emotes`);
            } catch(e) {
                document.getElementById('status').textContent = 'Ready (7TV fetch failed)';
                console.error('7TV load error:', e);
            }
        }

        function addSpam(key) {
            let item = spams.get(key) || {timestamps: []};
            item.timestamps.push(Date.now());
            item.timestamps = item.timestamps.filter(t => Date.now() - t < OLD_THRESHOLD);
            while (item.timestamps.length > MAX_TIMESTAMPS) item.timestamps.shift();
            spams.set(key, item);
        }

        function getScore(key) {
            const item = spams.get(key);
            if (!item) return 0;
            return item.timestamps.reduce((sum, t) => sum + Math.exp(-(Date.now() - t) / TAU), 0);
        }

        function updateDisplay() {
            if (spams.size === 0) {
                ['top1', 'top2', 'top3'].forEach((id, i) => {
                    document.getElementById(id).innerHTML = `Top ${i+1}: -`;
                });
                return;
            }
            const totalScore = Array.from(spams.keys()).reduce((sum, k) => sum + getScore(k), 0);
            const items = Array.from(spams.keys())
                .map(key => ({key: key.toLowerCase(), score: getScore(key)}))
                .filter(item => item.score > 0)
                .sort((a, b) => b.score - a.score)
                .slice(0, 3);
            const tops = ['top1', 'top2', 'top3'];
            for (let i = 0; i < 3; i++) {
                const el = document.getElementById(tops[i]);
                if (i >= items.length) {
                    el.innerHTML = `Top ${i+1}: -`;
                    continue;
                }
                const perc = totalScore > 0 ? Math.round((items[i].score / totalScore) * 100) : 0;
                let icon = items[i].key;
                // 7TV emote
                if (emoteMap.has(items[i].key)) {
                    icon = `<img src="${emoteMap.get(items[i].key)}" alt="${items[i].key}" />`;
                } else if (items[i].key === '1') {
                    icon = '<img src="1.jpg" alt="1" />';
                } else if (items[i].key === '2') {
                    icon = '<img src="2.jpg" alt="2" />';
                } else if (items[i].key === '3') {
                    icon = '<img src="3.jpg" alt="3" />';
                }
                el.innerHTML = `${icon} ${perc}%`;
            }
        }

        function parseAndProcess(raw) {
            if (raw.includes('PRIVMSG')) {
                const msgIndex = raw.indexOf('PRIVMSG ');
                const chanPart = raw.slice(msgIndex + 8);
                const message = chanPart.split(' :')[1]?.trim();
                if (message) {
                    message.toLowerCase().split(/\s+/).forEach(word => {
                        if ((/^[a-z]+$/.test(word) || /^[0-9]+$/.test(word)) && word.length > 0) {
                            addSpam(word);
                        }
                    });
                }
            }
        }

        function connect() {
            const channel = document.getElementById('channel').value.trim().toLowerCase();
            if (!channel) return alert('Enter channel');
            if (ws) ws.close();
            const nick = `justinfan${Math.floor(Math.random() * 90000) + 10000}`;
            ws = new WebSocket('wss://irc-ws.chat.twitch.tv:443');
            document.getElementById('status').textContent = 'Connecting...';
            ws.onopen = () => {
                ws.send('PASS schmoo');
                ws.send(`NICK ${nick}`);
                ws.send(`JOIN #${channel}`);
                document.getElementById('status').textContent = `Connected to #${channel}`;
            };
            ws.onmessage = (event) => {
                const lines = event.data.split('\r\n');
                for (const line of lines) {
                    if (line.trim()) {
                        if (line.startsWith('PING :tmi.twitch.tv')) {
                            ws.send('PONG :tmi.twitch.tv');
                        } else {
                            parseAndProcess(line);
                        }
                    }
                }
                updateDisplay();
            };
            ws.onclose = () => {
                document.getElementById('status').textContent = 'Disconnected (auto-reconnect)';
                setTimeout(connect, 5000);
            };
            ws.onerror = (e) => {
                document.getElementById('status').textContent = 'Connection error';
                console.error(e);
            };
        }

        setInterval(updateDisplay, 2000);
    </script>
</body>
</html>
